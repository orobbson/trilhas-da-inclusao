<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trilhas da Inclus√£o com IA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* O CSS continua exatamente o mesmo */
        :root {
            --base-font-size: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #6DD5FA, #FF758C);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
        }

        #startScreen {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px 40px;
            width: 100%;
            max-width: 500px;
            border-radius: 25px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        #startScreen h2 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        #startScreen p {
            font-size: 1.1rem;
            margin-bottom: 20px;
            color: #555;
        }

        #language-selection {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .lang-btn {
            font-size: 2rem;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 5px;
            transition: all 0.2s;
        }

        .lang-btn:hover,
        .lang-btn.selected {
            border-color: #3498db;
            transform: scale(1.1);
        }

        .age-selection {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .age-btn {
            background: linear-gradient(145deg, #1abc9c, #16a085);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .age-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        #gameContainer {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 40px;
            width: 100%;
            max-width: 800px;
            border-radius: 25px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            transition: all 0.5s ease;
            font-size: var(--base-font-size);
        }

        h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            background-color: #eee;
        }

        .image:hover {
            transform: scale(1.03);
        }

        .scene {
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 25px;
            min-height: 80px;
        }

        #choices {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .option,
        #restartBtn,
        .minigame-btn,
        .accessibility-btn {
            background: linear-gradient(145deg, #3498db, #2980b9);
            color: white;
            padding: 18px;
            border: none;
            border-radius: 12px;
            width: 100%;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .option:hover,
        #restartBtn:hover,
        .minigame-btn:hover {
            background: linear-gradient(145deg, #2980b9, #3498db);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        #restartBtn,
        #minigame-feedback-btn {
            margin-top: 20px;
            background: linear-gradient(145deg, #1abc9c, #16a085);
        }

        #restartBtn:hover,
        #minigame-feedback-btn:hover {
            background: linear-gradient(145deg, #16a085, #1abc9c);
        }

        #game-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .feedback {
            margin-top: 25px;
            font-size: 1.1em;
            font-style: italic;
            color: #555;
            min-height: 30px;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .feedback.visible {
            opacity: 1;
        }

        .scoreBarContainer {
            margin-top: 25px;
            background: #e0e0e0;
            height: 25px;
            border-radius: 12.5px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .scoreBar {
            height: 100%;
            background: linear-gradient(to right, #56ab2f, #a8e063);
            width: 0%;
            transition: width 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
            border-radius: 12.5px;
        }

        .final-report {
            margin-top: 25px;
            font-weight: 600;
            font-size: 1.2em;
            color: #2c3e50;
        }

        #loader {
            text-align: center;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .minigame {
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 15px;
        }

        .minigame-instructions {
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .minigame-area {
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            gap: 20px;
            flex-wrap: wrap;
        }

        .drag-items,
        .drop-targets {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            min-height: 100px;
            padding: 10px;
            border-radius: 10px;
        }

        .drag-items {
            border: 2px dashed #ccc;
        }

        .drag-item {
            width: 80px;
            height: 80px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            cursor: grab;
            font-size: 2.5rem;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .drop-target-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .drop-target {
            width: 90px;
            height: 90px;
            border: 3px dashed #aaa;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            font-size: 2.5rem;
            transition: all 0.3s;
        }

        .drop-target.hovered {
            background-color: #e0f7fa;
            border-color: #007acc;
        }

        .drop-target.correct {
            border-color: #2ecc71;
            background-color: #e8f8f5;
        }

        .drop-target.incorrect {
            border-color: #e74c3c;
            background-color: #fdedec;
        }

        .target-label {
            font-size: 1rem;
            font-weight: 600;
            width: 100px;
        }

        #empathyMinigame {
            text-align: left;
        }

        #empathyCharacterDialogue {
            background: #e9ecef;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #ced4da;
        }

        #empathyCharacterDialogue p {
            font-size: 1.1em;
            line-height: 1.6;
        }

        #empathyChoices {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .empathy-feedback {
            margin-top: 15px;
            font-style: italic;
            padding: 10px;
            border-radius: 10px;
        }

        .empathy-feedback.correct {
            background-color: #e8f8f5;
            color: #1e8449;
        }

        .empathy-feedback.incorrect {
            background-color: #fdedec;
            color: #b03a2e;
        }

        #accessibility-controls {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 15px;
        }

        .accessibility-btn {
            width: auto;
            padding: 10px;
            font-size: 1.2rem;
            background: #555;
        }

        .tts-btn {
            cursor: pointer;
            display: inline-block;
            vertical-align: middle;
            flex-shrink: 0;
        }

        body.high-contrast {
            background: #000;
            color: #fff;
        }

        .high-contrast #gameContainer,
        .high-contrast #startScreen {
            background: #111;
            color: #fff;
            border-color: #fff;
        }

        .high-contrast h1,
        .high-contrast h2,
        .high-contrast p,
        .high-contrast .target-label,
        .high-contrast #activity-counter {
            color: #fff;
        }

        .high-contrast .option,
        .high-contrast .minigame-btn,
        .high-contrast #restartBtn {
            background: #333;
            border: 2px solid #fff;
        }

        .high-contrast .drag-item {
            background: #444;
            color: #fff;
        }

        .high-contrast #empathyCharacterDialogue {
            background: #222;
            border-color: #555;
        }

        .high-contrast .feedback {
            color: #eee;
        }

        #keyboard-dnd details {
            margin-top: 15px;
            text-align: left;
        }

        #keyboard-dnd summary {
            cursor: pointer;
            font-weight: 600;
        }

        #keyboard-dnd-form {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 600px) {

            #gameContainer,
            #startScreen {
                padding: 20px;
                font-size: 14px;
            }

            h1 {
                font-size: 1.8em;
            }

            .scene,
            .minigame-instructions,
            #empathyCharacterDialogue p {
                font-size: 1.1em;
            }

            .option,
            #restartBtn,
            .age-btn,
            .minigame-btn {
                font-size: 1em;
                padding: 15px;
            }

            .minigame-area {
                flex-direction: column;
                align-items: center;
            }

            #accessibility-controls {
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div id="startScreen">
        <h2 data-i18n="welcome_title">Bem-vindo(a) √†s Trilhas da Inclus√£o!</h2>
        <div id="language-selection">
            <span class="lang-btn selected" data-lang="pt-BR" title="Portugu√™s">üáßüá∑</span>
            <span class="lang-btn" data-lang="en-US" title="English">üá∫üá∏</span>
            <span class="lang-btn" data-lang="es-ES" title="Espa√±ol">üá™üá∏</span>
        </div>
        <p data-i18n="age_prompt">Para come√ßar, por favor, selecione sua faixa et√°ria.</p>
        <div class="age-selection">
            <button class="age-btn" data-age="6 a 9" data-i18n="age_6_9">6 a 9 anos</button>
            <button class="age-btn" data-age="10 a 13" data-i18n="age_10_13">10 a 13 anos</button>
            <button class="age-btn" data-age="14+" data-i18n="age_14_plus">14+ anos</button>
        </div>
    </div>

    <div id="gameContainer" class="hidden">
        <div id="accessibility-controls">
            <button id="mute-toggle" class="accessibility-btn" title="Ativar/Desativar Som">üîä</button>
            <button id="contrast-toggle" class="accessibility-btn" title="Alto Contraste">üé®</button>
            <button id="decrease-font" class="accessibility-btn" title="Diminuir Fonte">A-</button>
            <button id="increase-font" class="accessibility-btn" title="Aumentar Fonte">A+</button>
        </div>
        <h1 data-i18n="game_title">Trilhas da Inclus√£o</h1>
        <div id="game-status">
            <span id="activity-counter" aria-live="polite"></span>
        </div>

        <div id="scenario-content">
            <img id="sceneImage" class="image" src="" alt="">
            <div class="scene" id="scene"></div>
            <div id="choices"></div>
        </div>

        <div id="accessibilityMinigame" class="minigame hidden"></div>
        <div id="empathyMinigame" class="minigame hidden"></div>

        <div id="loader" class="hidden">
            <div class="spinner"></div>
            <p data-i18n="loading_text">Preparando sua jornada de aprendizado...</p>
        </div>
        <div id="feedback" class="feedback" role="status" aria-live="polite"></div>
        <div class="scoreBarContainer">
            <div class="scoreBar" id="scoreBar"></div>
        </div>
        <div class="final-report" id="finalReport"></div>
        <div id="ai-controls" class="hidden">
            <button id="restartBtn" data-i18n="play_again">Jogar Novamente</button>
        </div>
    </div>

    <script>
        // --- VARI√ÅVEIS DE ESTADO DO JOGO ---
        let score = 0, maxScore = 0, activityCount = 0;
        const TOTAL_ACTIVITIES = 5;
        let userAgeRange = '', currentLanguage = 'pt-BR';
        let isAudioReady = false, isMuted = false, isOfflineMode = false, keyboardMode = false;
        let scenarioQueue = [], fallbackQueue = [], voice = null;

        // --- ELEMENTOS DO DOM ---
        const startScreen = document.getElementById("startScreen");
        const gameContainer = document.getElementById("gameContainer");
        const scenarioContent = document.getElementById("scenario-content");
        const sceneTextElement = document.getElementById("scene");
        const sceneImageElement = document.getElementById("sceneImage");
        const choicesContainer = document.getElementById("choices");
        const feedbackElement = document.getElementById("feedback");
        const scoreBarElement = document.getElementById("scoreBar");
        const finalReportElement = document.getElementById("finalReport");
        const aiControls = document.getElementById("ai-controls");
        const restartBtn = document.getElementById("restartBtn");
        const loader = document.getElementById("loader");
        const accessibilityMinigameContainer = document.getElementById("accessibilityMinigame");
        const empathyMinigameContainer = document.getElementById("empathyMinigame");
        const activityCounterElement = document.getElementById("activity-counter");

        // --- CONFIGURA√á√ÉO DE √ÅUDIO ---
        const synth = new Tone.Synth().toDestination();

        // --- DICION√ÅRIO DE TRADU√á√ïES (i18n) ---
        const i18n = {
            'pt-BR': {
                welcome_title: "Bem-vindo(a) √†s Trilhas da Inclus√£o!", age_prompt: "Para come√ßar, por favor, selecione sua faixa et√°ria.", age_6_9: "6 a 9 anos", age_10_13: "10 a 13 anos", age_14_plus: "14+ anos", game_title: "Trilhas da Inclus√£o", loading_text: "Preparando sua jornada de aprendizado...", play_again: "Jogar Novamente", activity_counter_text: (c, t) => `Atividade ${c} de ${t}`, final_report_text: (s, m) => `Parab√©ns! Voc√™ completou a jornada e marcou ${s} de ${m} pontos.`, accessibility_minigame_instructions: "Desafio B√¥nus: Arraste cada s√≠mbolo para o seu nome correto!", check_result_btn: "Ver Resultado", offline_loaded: "Modo offline carregado. Cen√°rios locais prontos!", tts_listen_text: "Ouvir texto", tts_listen_option: "Ouvir op√ß√£o", tts_listen_feedback: "Ouvir feedback", mute_title: "Ativar/Desativar Som", contrast_title: "Alto Contraste", font_inc_title: "Aumentar Fonte", font_dec_title: "Diminuir Fonte", keyboard_mode_label: "Modo acess√≠vel por teclado", dnd_keyboard_hint: "Dica: pressione K para modo acess√≠vel por teclado.", final_tip_good: "Excelente consci√™ncia inclusiva!", final_tip_medium: "Bom caminho. Reflita nas escolhas.", final_tip_low: "Que tal tentar de novo e explorar outras estrat√©gias?",
                offline_scenarios: [{ text: "Na hora do lanche, voc√™ v√™ um colega novo sentado sozinho. O que voc√™ faz?", image_query: "school cafeteria friends", options: [{ text: "Continuo com meus amigos, ele deve querer ficar s√≥.", score: 0, feedback: "√Äs vezes, um convite √© tudo que a pessoa precisa para se sentir bem-vinda." }, { text: "Chamo ele para sentar com voc√™ e seus amigos.", score: 1, feedback: "√ìtima atitude! Um simples convite pode fazer toda a diferen√ßa no dia de algu√©m." }] }, { text: "Durante a apresenta√ß√£o de um trabalho, um colega com gagueira come√ßa a falar. Alguns riem baixo.", image_query: "student presentation classroom", options: [{ text: "Pe√ßo sil√™ncio e aten√ß√£o da turma com um olhar s√©rio.", score: 1, feedback: "Excelente! Defender um colega e mostrar respeito cria um ambiente seguro para todos." }, { text: "Finjo que n√£o ouvi as risadas para n√£o criar confus√£o.", score: 0, feedback: "Omitir-se em uma situa√ß√£o de desrespeito pode magoar tanto quanto rir junto." }] }, { text: "A professora pede para formar duplas, e um colega com s√≠ndrome de Down fica sem par.", image_query: "classroom students working together", options: [{ text: "Espero a professora resolver a situa√ß√£o.", score: 0, feedback: "A inclus√£o √© uma atitude de todos, n√£o apenas dos professores. A proatividade √© fundamental." }, { text: "Convido ele para fazer o trabalho com voc√™.", score: 1, feedback: "Atitude incr√≠vel! A inclus√£o acontece quando abrimos espa√ßo para o outro em nossas atividades." }] }],
                empathy_minigame: { instructions: "Seu colega L√©o parece sobrecarregado. Escolha a melhor forma de falar com ele.", turns: [{ character: "L√©o", dialogue: "Nossa... √© muita coisa pra fazer, n√£o sei nem por onde come√ßar. Estou travado.", choices: [{ text: "√â s√≥ se organizar que d√°.", isCorrect: false, feedback: "Essa frase pode soar como um julgamento e simplifica demais o problema dele." }, { text: "Quer ajuda para listar as tarefas? √Äs vezes, ver no papel ajuda.", isCorrect: true, feedback: "√ìtimo! Oferecer ajuda pr√°tica e sem julgamento √© muito emp√°tico." }] }, { character: "L√©o", dialogue: "Acho que sim... Obrigado. √â que todo mundo parece dar conta, menos eu.", choices: [{ text: "N√£o se compare. Cada um tem seu ritmo. Foca em um passo de cada vez.", isCorrect: true, feedback: "Excelente! Validar o sentimento dele e oferecer uma perspectiva positiva √© muito acolhedor." }, { text: "Deixa de drama, todo mundo se sente assim.", isCorrect: false, feedback: "Minimizar o sentimento dele pode faz√™-lo se sentir pior e invalidado." }] }] }
            },
            'en-US': {
                welcome_title: "Welcome to the Inclusion Trails!", age_prompt: "To start, please select your age group.", age_6_9: "6 to 9 years old", age_10_13: "10 to 13 years old", age_14_plus: "14+ years old", game_title: "Inclusion Trails", loading_text: "Preparing your learning journey...", play_again: "Play Again", activity_counter_text: (c, t) => `Activity ${c} of ${t}`, final_report_text: (s, m) => `Congratulations! You completed the journey and scored ${s} out of ${m} points.`, accessibility_minigame_instructions: "Bonus Challenge: Drag each symbol to its correct name!", check_result_btn: "Check Result", offline_loaded: "Offline mode loaded. Local scenarios are ready!", tts_listen_text: "Listen to text", tts_listen_option: "Listen to option", tts_listen_feedback: "Listen to feedback", mute_title: "Mute/Unmute Sound", contrast_title: "High Contrast", font_inc_title: "Increase Font", font_dec_title: "Decrease Font", keyboard_mode_label: "Accessible keyboard mode", dnd_keyboard_hint: "Tip: press K for accessible keyboard mode.", final_tip_good: "Excellent inclusive awareness!", final_tip_medium: "Good progress. Reflect on the choices.", final_tip_low: "How about trying again and exploring other strategies?",
                offline_scenarios: [{ text: "At lunchtime, you see a new classmate sitting alone. What do you do?", image_query: "school cafeteria friends", options: [{ text: "I stay with my friends; he probably wants to be alone.", score: 0, feedback: "Sometimes, an invitation is all someone needs to feel welcome." }, { text: "I invite him to sit with you and your friends.", score: 1, feedback: "Great attitude! A simple invitation can make a huge difference in someone's day." }] }, { text: "During a presentation, a classmate with a stutter starts speaking. Some students quietly laugh.", image_query: "student presentation classroom", options: [{ text: "I ask the class for silence and attention with a serious look.", score: 1, feedback: "Excellent! Standing up for a classmate and showing respect creates a safe environment for everyone." }, { text: "I pretend not to hear the laughter to avoid trouble.", score: 0, feedback: "Ignoring disrespect can be as hurtful as laughing along." }] }, { text: "The teacher asks to form pairs, and a classmate with Down syndrome is left without a partner.", image_query: "classroom students working together", options: [{ text: "I wait for the teacher to solve the situation.", score: 0, feedback: "Inclusion is everyone's responsibility, not just the teacher's. Being proactive is key." }, { text: "I invite them to work with me.", score: 1, feedback: "Amazing attitude! Inclusion happens when we make space for others in our activities." }] }],
                empathy_minigame: { instructions: "Your classmate Leo seems overwhelmed. Choose the best way to talk to him.", turns: [{ character: "Leo", dialogue: "Wow... there's so much to do, I don't even know where to start. I'm stuck.", choices: [{ text: "Just get organized and you'll be fine.", isCorrect: false, feedback: "This phrase can sound judgmental and oversimplifies his problem." }, { text: "Do you want help listing the tasks? Sometimes seeing it on paper helps.", isCorrect: true, feedback: "Great! Offering practical help without judgment is very empathetic." }] }, { character: "Leo", dialogue: "I think so... Thanks. It's just that everyone else seems to manage, except me.", choices: [{ text: "Don't compare yourself. Everyone has their own pace. Focus on one step at a time.", isCorrect: true, feedback: "Excellent! Validating his feelings and offering a positive perspective is very supportive." }, { text: "Stop being dramatic, everyone feels that way.", isCorrect: false, feedback: "Minimizing his feelings can make him feel worse and invalidated." }] }] }
            },
            'es-ES': {
                welcome_title: "¬°Bienvenido(a) a los Senderos de la Inclusi√≥n!", age_prompt: "Para comenzar, por favor, selecciona tu grupo de edad.", age_6_9: "6 a 9 a√±os", age_10_13: "10 a 13 a√±os", age_14_plus: "14+ a√±os", game_title: "Senderos de la Inclusi√≥n", loading_text: "Preparando tu viaje de aprendizaje...", play_again: "Jugar de Nuevo", activity_counter_text: (c, t) => `Actividad ${c} de ${t}`, final_report_text: (s, m) => `¬°Felicidades! Completaste el viaje y obtuviste ${s} de ${m} puntos.`, accessibility_minigame_instructions: "¬°Reto Extra: Arrastra cada s√≠mbolo a su nombre correcto!", check_result_btn: "Ver Resultado", offline_loaded: "Modo sin conexi√≥n cargado. ¬°Los escenarios locales est√°n listos!", tts_listen_text: "Escuchar texto", tts_listen_option: "Escuchar opci√≥n", tts_listen_feedback: "Escuchar comentario", mute_title: "Activar/Desactivar Sonido", contrast_title: "Alto Contraste", font_inc_title: "Aumentar Fuente", font_dec_title: "Disminuir Fuente", keyboard_mode_label: "Modo accesible por teclado", dnd_keyboard_hint: "Consejo: presiona K para el modo accesible por teclado.", final_tip_good: "¬°Excelente conciencia inclusiva!", final_tip_medium: "Buen camino. Reflexiona sobre las opciones.", final_tip_low: "¬øQu√© tal si intentas de nuevo y exploras otras estrategias?",
                offline_scenarios: [{ text: "A la hora del almuerzo, ves a un compa√±ero nuevo sentado solo. ¬øQu√© haces?", image_query: "school cafeteria friends", options: [{ text: "Me quedo con mis amigos, seguro que quiere estar solo.", score: 0, feedback: "A veces, una invitaci√≥n es todo lo que una persona necesita para sentirse bienvenida." }, { text: "Lo invito a sentarse contigo y tus amigos.", score: 1, feedback: "¬°Gran actitud! Una simple invitaci√≥n puede marcar una gran diferencia en el d√≠a de alguien." }] }, { text: "Durante una presentaci√≥n, un compa√±ero que tartamudea empieza a hablar. Algunos se r√≠en en voz baja.", image_query: "student presentation classroom", options: [{ text: "Pido silencio y atenci√≥n a la clase con una mirada seria.", score: 1, feedback: "¬°Excelente! Defender a un compa√±ero y mostrar respeto crea un ambiente seguro para todos." }, { text: "Finjo no o√≠r las risas para no crear problemas.", score: 0, feedback: "Ignorar una falta de respeto puede doler tanto como re√≠rse." }] }, { text: "La profesora pide formar parejas y un compa√±ero con s√≠ndrome de Down se queda sin pareja.", image_query: "classroom students working together", options: [{ text: "Espero a que la profesora resuelva la situaci√≥n.", score: 0, feedback: "La inclusi√≥n es responsabilidad de todos, no solo de los profesores. Ser proactivo es fundamental." }, { text: "Le invito a trabajar conmigo.", score: 1, feedback: "¬°Actitud incre√≠ble! La inclusi√≥n ocurre cuando hacemos espacio para los dem√°s en nuestras actividades." }] }],
                empathy_minigame: { instructions: "Tu compa√±ero Leo parece abrumado. Elige la mejor manera de hablar con √©l.", turns: [{ character: "Leo", dialogue: "Vaya... hay tanto que hacer, no s√© ni por d√≥nde empezar. Estoy atascado.", choices: [{ text: "Solo organ√≠zate y ya est√°.", isCorrect: false, feedback: "Esa frase puede sonar como un juicio y simplifica demasiado su problema." }, { text: "¬øQuieres ayuda para hacer una lista de las tareas? A veces verlo en papel ayuda.", isCorrect: true, feedback: "¬°Genial! Ofrecer ayuda pr√°ctica sin juzgar es muy emp√°tico." }] }, { character: "Leo", dialogue: "Creo que s√≠... Gracias. Es que parece que todos los dem√°s pueden con todo, menos yo.", choices: [{ text: "No te compares. Cada uno tiene su propio ritmo. Conc√©ntrate en un paso a la vez.", isCorrect: true, feedback: "¬°Excelente! Validar sus sentimientos y ofrecer una perspectiva positiva es de gran apoyo." }, { text: "Deja el drama, todo el mundo se siente as√≠.", isCorrect: false, feedback: "Minimizar sus sentimientos puede hacerlo sentir peor e invalidado." }] }] }
            }
        };
        const offlineImages = ['https://images.unsplash.com/photo-1577896851231-70ef18881754?q=80&w=800&auto=format&fit=crop', 'https://images.unsplash.com/photo-1541534401786-2077ed84a95a?q=80&w=800&auto=format&fit=crop', 'https://images.unsplash.com/photo-1519751068422-ab6f1941699f?q=80&w=800&auto=format&fit=crop'];
        const accessibilitySymbolPool = [{ id: 'drag-cadeira', symbol: '‚ôø', label: 'Acessibilidade' }, { id: 'drag-braille', symbol: '‚†è', label: 'Braille' }, { id: 'drag-libras', symbol: 'ü§ü', label: 'Libras' }, { id: 'drag-cao', symbol: 'ü¶Æ', label: 'C√£o-Guia' }, { id: 'drag-auditiva', symbol: 'üßè', label: 'Def. Auditiva' }, { id: 'drag-autista', symbol: '‚ôæÔ∏è', label: 'Neurodiversidade' }];

        // --- FUN√á√ïES DE S√çNTESE DE VOZ (TTS) ---
        function ensureVoicesReady() {
            return new Promise(resolve => {
                const voices = window.speechSynthesis.getVoices();
                if (voices.length) return resolve(voices);
                window.speechSynthesis.onvoiceschanged = () => resolve(window.speechSynthesis.getVoices());
            });
        }

        async function initTTS() {
            const voices = await ensureVoicesReady();
            const langCode = currentLanguage.split('-')[0];
            voice = voices.find(v => v.lang === currentLanguage) || voices.find(v => v.lang.startsWith(langCode)) || null;
        }

        function speakText(text) {
            if (isMuted || !('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            if (voice) utterance.voice = voice;
            utterance.lang = currentLanguage;
            window.speechSynthesis.speak(utterance);
        }

        // --- FUN√á√ïES PRINCIPAIS DO JOGO ---

        async function startGame(age) {
            userAgeRange = age;
            startScreen.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            Tone.start().then(() => isAudioReady = true).catch(e => console.error("√Åudio bloqueado.", e));

            await fetchScenarioBatch();
            if (scenarioQueue.length > 0 || fallbackQueue.length > 0) {
                nextActivity();
            }
        }

        function playSound(type) {
            if (isMuted || !isAudioReady) return;
            try {
                if (type === 'correct') synth.triggerAttackRelease("C5", "8n");
                else synth.triggerAttackRelease("C3", "8n");
            } catch (e) { console.error("Erro ao tocar som:", e); }
        }

        function updateScoreBar() {
            const progress = maxScore > 0 ? (score / maxScore) * 100 : 0;
            scoreBarElement.style.width = progress + "%";
        }

        function nextActivity() {
            hideAllContainers();
            activityCount++;

            if (activityCount > TOTAL_ACTIVITIES) {
                showFinalScreen();
                return;
            }

            activityCounterElement.textContent = i18n[currentLanguage].activity_counter_text(activityCount, TOTAL_ACTIVITIES);

            let nextElementToFocus = null;

            if (activityCount === 2) {
                setupAccessibilityMinigame();
                nextElementToFocus = accessibilityMinigameContainer.querySelector('.drag-item');
            } else if (activityCount === 4) {
                setupEmpathyMinigame();
                nextElementToFocus = empathyMinigameContainer.querySelector('.minigame-btn');
            } else if (scenarioQueue.length > 0) {
                loadScenario(scenarioQueue.shift());
                nextElementToFocus = choicesContainer.querySelector('.option');
            } else {
                if (fallbackQueue.length === 0) {
                    refillFallbackQueue();
                }
                loadScenario(fallbackQueue.shift());
                nextElementToFocus = choicesContainer.querySelector('.option');
            }

            setTimeout(() => {
                if (nextElementToFocus) nextElementToFocus.focus();
            }, 100);
        }

        function showFinalScreen() {
            hideAllContainers();
            const pct = Math.round((score / (maxScore || 1)) * 100);
            let tipKey = pct >= 85 ? "final_tip_good" : pct >= 60 ? "final_tip_medium" : "final_tip_low";
            const tip = i18n[currentLanguage][tipKey];

            finalReportElement.innerHTML = `
            <p>${i18n[currentLanguage].final_report_text(score, maxScore)}</p>
            <p style="margin-top:8px">Aproveitamento: <strong>${pct}%</strong> ¬∑ ${tip}</p>
        `;
            aiControls.classList.remove('hidden');
            restartBtn.focus();
        }

        // --- CEN√ÅRIOS GERADOS PELA IA ---

        function loadScenario(sceneObject) {
            scenarioContent.classList.remove('hidden');

            const sceneTextNode = document.createElement('span');
            sceneTextNode.textContent = sceneObject.text;
            sceneTextElement.innerHTML = '';
            sceneTextElement.appendChild(sceneTextNode);

            const ttsBtn = document.createElement('button');
            ttsBtn.className = 'tts-btn accessibility-btn';
            ttsBtn.setAttribute('aria-label', i18n[currentLanguage].tts_listen_text);
            ttsBtn.innerHTML = '<span aria-hidden="true">üîä</span>';
            ttsBtn.onclick = () => speakText(sceneObject.text);
            sceneTextElement.appendChild(ttsBtn);

            const img = sceneObject.image || (sceneObject.image_query ? `https://source.unsplash.com/800x300/?${encodeURIComponent(sceneObject.image_query)}` : offlineImages[Math.floor(Math.random() * offlineImages.length)]);
            sceneImageElement.src = img;
            sceneImageElement.alt = sceneObject.text;
            sceneImageElement.onerror = () => {
                sceneImageElement.src = offlineImages[Math.floor(Math.random() * offlineImages.length)];
            };

            choicesContainer.innerHTML = "";
            if (!isOfflineMode) maxScore++;
            updateScoreBar();

            sceneObject.options.forEach(opt => {
                const btn = document.createElement("button");
                btn.className = "option";

                const textSpan = document.createElement('span');
                textSpan.textContent = opt.text;

                const ttsSpan = document.createElement('button');
                ttsSpan.className = 'tts-btn accessibility-btn';
                ttsSpan.setAttribute('aria-label', i18n[currentLanguage].tts_listen_option);
                ttsSpan.innerHTML = '<span aria-hidden="true">üîä</span>';

                btn.appendChild(textSpan);
                btn.appendChild(ttsSpan);

                btn.onclick = (e) => {
                    if (e.target.closest('.tts-btn') === ttsSpan) {
                        speakText(opt.text);
                        e.stopPropagation();
                    } else {
                        selectScenarioOption(opt);
                    }
                };
                choicesContainer.appendChild(btn);
            });
        }

        function selectScenarioOption(option) {
            if (option.score > 0) {
                score++;
                playSound('correct');
            } else {
                playSound('wrong');
            }
            updateScoreBar();

            const feedbackTextNode = document.createElement('span');
            feedbackTextNode.textContent = option.feedback;
            feedbackElement.innerHTML = '';
            feedbackElement.appendChild(feedbackTextNode);

            const ttsBtn = document.createElement('button');
            ttsBtn.className = 'tts-btn accessibility-btn';
            ttsBtn.setAttribute('aria-label', i18n[currentLanguage].tts_listen_feedback);
            ttsBtn.innerHTML = '<span aria-hidden="true">üîä</span>';
            ttsBtn.onclick = () => speakText(option.feedback);
            feedbackElement.appendChild(ttsBtn);

            feedbackElement.classList.add('visible');
            choicesContainer.querySelectorAll('.option').forEach(btn => btn.disabled = true);

            setTimeout(() => {
                feedbackElement.classList.remove('visible');
                nextActivity();
            }, 3500);
        }

        // --- CONTROLE DOS MINIJOGOS ---

        function hideAllContainers() {
            scenarioContent.classList.add('hidden');
            accessibilityMinigameContainer.classList.add('hidden');
            empathyMinigameContainer.classList.add('hidden');
            aiControls.classList.add('hidden');
            loader.classList.add('hidden');
            finalReportElement.textContent = '';
        }

        // --- MINIJOGO DE ACESSIBILIDADE ---

        function setupAccessibilityMinigame() {
            accessibilityMinigameContainer.classList.remove('hidden');

            const shuffledSymbols = [...accessibilitySymbolPool].sort(() => 0.5 - Math.random());
            const selectedSymbols = shuffledSymbols.slice(0, 3);
            if (!isOfflineMode) maxScore += selectedSymbols.length;

            const instructions = i18n[currentLanguage].accessibility_minigame_instructions;
            accessibilityMinigameContainer.innerHTML = `
            <p class="minigame-instructions"><span>${instructions}</span> <button class="tts-btn accessibility-btn" aria-label="${i18n[currentLanguage].tts_listen_text}"><span aria-hidden="true">üîä</span></button></p>
            <div class="minigame-area">
                <div class="drag-items" id="drag-source">
                    ${selectedSymbols.map(s => `<div class="drag-item" draggable="true" id="${s.id}">${s.symbol}</div>`).join('')}
                </div>
                <div class="drop-targets">
                    ${selectedSymbols.sort(() => 0.5 - Math.random()).map(s => `
                        <div class="drop-target-wrapper">
                            <div class="drop-target" data-accepts="${s.id}"></div>
                            <span class="target-label">${s.label}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            <div id="minigame-feedback">
                <button id="minigame-feedback-btn" class="minigame-btn hidden">${i18n[currentLanguage].check_result_btn}</button>
            </div>
            <div id="keyboard-dnd"></div>
        `;
            accessibilityMinigameContainer.querySelector('.tts-btn').onclick = () => speakText(instructions);
            addDragDropListeners();
            const hint = document.createElement('p');
            hint.style.marginTop = '8px';
            hint.style.fontSize = '0.95rem';
            hint.textContent = i18n[currentLanguage].dnd_keyboard_hint;
            document.getElementById('keyboard-dnd').before(hint);
            if (keyboardMode) renderKeyboardDnD();
            updateScoreBar();
        }

        function addDragDropListeners() {
            const draggables = accessibilityMinigameContainer.querySelectorAll('.drag-item');
            const dropzones = accessibilityMinigameContainer.querySelectorAll('.drop-target, #drag-source');
            const checkBtn = document.getElementById('minigame-feedback-btn');

            draggables.forEach(item => {
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.setData("text/plain", e.target.id);
                    setTimeout(() => e.target.style.visibility = 'hidden', 0);
                });
                item.addEventListener('dragend', e => e.target.style.visibility = 'visible');
            });

            dropzones.forEach(zone => {
                zone.addEventListener('dragover', e => { e.preventDefault(); if (zone.id !== 'drag-source') zone.classList.add('hovered'); });
                zone.addEventListener('dragleave', e => zone.classList.remove('hovered'));
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    zone.classList.remove('hovered');
                    const id = e.dataTransfer.getData("text");
                    const draggedElement = document.getElementById(id);

                    if (zone.id === 'drag-source' || zone.children.length === 0) {
                        if (zone.children.length > 0) {
                            document.getElementById('drag-source').appendChild(zone.firstElementChild);
                        }
                        zone.appendChild(draggedElement);
                    }

                    const dropTargets = accessibilityMinigameContainer.querySelectorAll('.drop-target');
                    const totalInTargets = Array.from(dropTargets).reduce((acc, t) => acc + t.children.length, 0);
                    checkBtn.classList.toggle('hidden', totalInTargets !== draggables.length);
                });
            });

            checkBtn.addEventListener('click', () => {
                let minigameScore = 0;
                accessibilityMinigameContainer.querySelectorAll('.drop-target').forEach(target => {
                    const acceptedId = target.dataset.accepts;
                    const child = target.querySelector('.drag-item');
                    if (child && child.id === acceptedId) {
                        target.classList.add('correct');
                        minigameScore++;
                    } else {
                        target.classList.add('incorrect');
                    }
                });
                score += minigameScore;
                playSound(minigameScore > 0 ? 'correct' : 'wrong');
                updateScoreBar();
                checkBtn.disabled = true;
                setTimeout(nextActivity, 2500);
            }, { once: true });
        }

        function renderKeyboardDnD() {
            const container = document.getElementById('keyboard-dnd');
            const symbols = [...accessibilityMinigameContainer.querySelectorAll('.drag-item')].map(el => ({ id: el.id, symbol: el.textContent, label: accessibilitySymbolPool.find(s => s.id === el.id).label }));
            const targets = [...accessibilityMinigameContainer.querySelectorAll('.drop-target-wrapper')].map((w, i) => ({ index: i, label: w.querySelector('.target-label').textContent }));

            container.innerHTML = `
          <details style="margin-top:12px;">
            <summary>${i18n[currentLanguage].keyboard_mode_label}</summary>
            <div id="keyboard-dnd-form" style="margin-top:10px; display:flex; flex-direction:column; gap:8px; align-items:flex-start;">
              ${targets.map(t => `
                <label>
                  <span>${t.label}:</span>
                  <select data-target-index="${t.index}">
                    <option value="">‚Äî</option>
                    ${symbols.map(s => `<option value="${s.id}">${s.symbol} (${s.label})</option>`).join('')}
                  </select>
                </label>
              `).join('')}
            </div>
          </details>`;

            container.addEventListener('change', () => {
                const selects = [...container.querySelectorAll('select')];
                const allFilled = selects.every(s => s.value);
                const btn = document.getElementById('minigame-feedback-btn');
                btn.classList.toggle('hidden', !allFilled);

                // Simulate drop for immediate feedback
                selects.forEach(select => {
                    const target = accessibilityMinigameContainer.querySelectorAll('.drop-target')[select.dataset.targetIndex];
                    if (target.firstChild) {
                        document.getElementById('drag-source').appendChild(target.firstChild);
                    }
                    if (select.value) {
                        const elem = accessibilityMinigameContainer.querySelector(`#${select.value}`);
                        if (elem) target.appendChild(elem);
                    }
                });
            });
        }

        // --- MINIJOGO DE EMPATIA ---

        function setupEmpathyMinigame() {
            empathyMinigameContainer.classList.remove('hidden');
            if (!isOfflineMode) maxScore += i18n[currentLanguage].empathy_minigame.turns.length;

            const instructions = i18n[currentLanguage].empathy_minigame.instructions;
            empathyMinigameContainer.innerHTML = `
            <p class="minigame-instructions"><span>${instructions}</span> <button class="tts-btn accessibility-btn" aria-label="${i18n[currentLanguage].tts_listen_text}"><span aria-hidden="true">üîä</span></button></p>
            <div id="empathyCharacterDialogue"></div>
            <div id="empathyChoices"></div>
            <div id="empathyFeedback" class="feedback"></div>
        `;
            empathyMinigameContainer.querySelector('.tts-btn').onclick = () => speakText(instructions);

            displayEmpathyTurn(0);
            updateScoreBar();
        }

        function displayEmpathyTurn(turnIndex) {
            const turn = i18n[currentLanguage].empathy_minigame.turns[turnIndex];
            if (!turn) {
                setTimeout(nextActivity, 2000);
                return;
            }

            const dialogueElement = document.getElementById('empathyCharacterDialogue');
            const p = document.createElement('p');
            const strong = document.createElement('strong');
            strong.textContent = `${turn.character}: `;
            const textSpan = document.createElement('span');
            textSpan.textContent = `"${turn.dialogue}"`;
            const ttsBtn = document.createElement('button');
            ttsBtn.className = 'tts-btn accessibility-btn';
            ttsBtn.setAttribute('aria-label', i18n[currentLanguage].tts_listen_text);
            ttsBtn.innerHTML = '<span aria-hidden="true">üîä</span>';
            ttsBtn.onclick = () => speakText(turn.dialogue);
            p.appendChild(strong);
            p.appendChild(textSpan);
            p.appendChild(ttsBtn);
            dialogueElement.innerHTML = '';
            dialogueElement.appendChild(p);

            const choicesDiv = document.getElementById('empathyChoices');
            choicesDiv.innerHTML = '';
            document.getElementById('empathyFeedback').classList.remove('visible');

            turn.choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'minigame-btn';

                const textSpan = document.createElement('span');
                textSpan.textContent = choice.text;
                const ttsSpan = document.createElement('button');
                ttsSpan.className = 'tts-btn accessibility-btn';
                ttsSpan.setAttribute('aria-label', i18n[currentLanguage].tts_listen_option);
                ttsSpan.innerHTML = '<span aria-hidden="true">üîä</span>';

                btn.appendChild(textSpan);
                btn.appendChild(ttsSpan);

                btn.onclick = (e) => {
                    if (e.target.closest('.tts-btn') === ttsSpan) {
                        speakText(choice.text);
                        e.stopPropagation();
                        return;
                    }
                    if (choice.isCorrect) {
                        score++;
                        playSound('correct');
                    } else {
                        playSound('wrong');
                    }
                    updateScoreBar();

                    const feedbackDiv = document.getElementById('empathyFeedback');
                    const feedbackTextNode = document.createElement('span');
                    feedbackTextNode.textContent = choice.feedback;
                    const feedbackTtsBtn = document.createElement('button');
                    feedbackTtsBtn.className = 'tts-btn accessibility-btn';
                    feedbackTtsBtn.setAttribute('aria-label', i18n[currentLanguage].tts_listen_feedback);
                    feedbackTtsBtn.innerHTML = '<span aria-hidden="true">üîä</span>';
                    feedbackTtsBtn.onclick = () => speakText(choice.feedback);
                    feedbackDiv.innerHTML = '';
                    feedbackDiv.appendChild(feedbackTextNode);
                    feedbackDiv.appendChild(feedbackTtsBtn);

                    feedbackDiv.className = `feedback empathy-feedback ${choice.isCorrect ? 'correct' : 'incorrect'}`;
                    feedbackDiv.classList.add('visible');

                    choicesDiv.querySelectorAll('button').forEach(b => b.disabled = true);
                    setTimeout(() => displayEmpathyTurn(turnIndex + 1), 3500);
                };
                choicesDiv.appendChild(btn);
            });
            if (choicesDiv.querySelector('button')) {
                choicesDiv.querySelector('button').focus();
            }
        }

        // --- FUN√á√ÉO DA API GEMINI ---
        function refillFallbackQueue() {
            const offlineClone = JSON.parse(JSON.stringify(i18n[currentLanguage].offline_scenarios));
            offlineClone.forEach(s => {
                s.image = `https://source.unsplash.com/800x300/?${encodeURIComponent(s.image_query)}`;
            });
            fallbackQueue = offlineClone;
        }

        async function fetchScenarioBatch() {
            loader.classList.remove('hidden');

            // Se estiver no app Android (asset local) ou dev, use dom√≠nio completo:
            const API_BASE =
                location.origin.startsWith('file://') || location.hostname === ''
                    ? 'https://trilhas-da-inclusao.vercel.app' // troque pelo seu dom√≠nio Vercel
                    : ''; // em produ√ß√£o web, pode ser relativo

            const langName = { 'pt-BR': 'Portugu√™s do Brasil', 'en-US': 'Ingl√™s', 'es-ES': 'Espanhol' }[currentLanguage];
            const prompt = `Crie um lote de 3 cen√°rios √∫nicos para um jogo educacional sobre inclus√£o. Faixa et√°ria: "${userAgeRange} anos". IMPORTANTE: Gere todo o texto estritamente em ${langName}. Para cada cen√°rio, forne√ßa: 'text' (situa√ß√£o), 'image_query' (em ingl√™s), e 'options' (array de 2 objetos com 'text', 'score' (0 ou 1), e 'feedback')).`;

            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "text": { "type": "STRING" },
                                "image_query": { "type": "STRING" },
                                "options": {
                                    "type": "ARRAY",
                                    "items": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "text": { "type": "STRING" },
                                            "score": { "type": "NUMBER" },
                                            "feedback": { "type": "STRING" }
                                        },
                                        "required": ["text", "score", "feedback"]
                                    }
                                }
                            },
                            "required": ["text", "image_query", "options"]
                        }
                    }
                }
            };

            try {
                // Chama seu proxy (serverless) em vez de chamar o Google direto
                const response = await fetch(`${API_BASE}/api/gemini`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ promptPayload: payload })
                });

                if (!response.ok) throw new Error('Proxy error');
                const result = await response.json();

                if (!result?.candidates?.[0]?.content?.parts?.[0]?.text) {
                    throw new Error("API response invalid.");
                }

                const newScenarios = JSON.parse(result.candidates[0].content.parts[0].text);
                newScenarios.forEach(s => {
                    s.image = `https://source.unsplash.com/800x300/?${encodeURIComponent(s.image_query)}`;
                    scenarioQueue.push(s);
                });

                // Em modo online, maxScore ser√° calculado ao longo das atividades
            } catch (error) {
                console.error("Erro via proxy, usando fallback:", error);
                isOfflineMode = true;
                maxScore = 3 + 3 + i18n[currentLanguage].empathy_minigame.turns.length;
                refillFallbackQueue();
                scenarioQueue.push(...fallbackQueue);
                const loaderText = loader.querySelector('p');
                loaderText.textContent = i18n[currentLanguage].offline_loaded;
            } finally {
                loader.classList.add('hidden');
            }
        }


        // --- INICIALIZA√á√ÉO E CONTROLES DE ACESSIBILIDADE ---
        function setLanguage(lang) {
            currentLanguage = lang;
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (i18n[lang] && i18n[lang][key]) {
                    const content = i18n[lang][key];
                    el.textContent = typeof content === 'function' ? content(0, 0) : content;
                }
            });
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.lang === lang);
            });
            document.getElementById('mute-toggle').title = i18n[lang].mute_title;
            document.getElementById('contrast-toggle').title = i18n[lang].contrast_title;
            document.getElementById('increase-font').title = i18n[lang].font_inc_title;
            document.getElementById('decrease-font').title = i18n[lang].font_dec_title;
            initTTS();
        }

        function applyPreferences() {
            if (localStorage.getItem('pref_muted') === '1') {
                isMuted = true;
                document.getElementById('mute-toggle').textContent = 'üîá';
            }
            if (localStorage.getItem('pref_contrast') === '1') {
                document.body.classList.add('high-contrast');
            }
            const savedFontSize = localStorage.getItem('pref_fontSize');
            if (savedFontSize) {
                gameContainer.style.fontSize = savedFontSize;
            }
        }

        restartBtn.addEventListener('click', () => window.location.reload());

        document.querySelectorAll('.age-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                startGame(e.target.getAttribute('data-age'));
            });
        });

        document.querySelectorAll('.lang-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                setLanguage(e.target.dataset.lang);
            });
        });

        document.getElementById('mute-toggle').addEventListener('click', (e) => {
            isMuted = !isMuted;
            e.target.textContent = isMuted ? 'üîá' : 'üîä';
            localStorage.setItem('pref_muted', isMuted ? '1' : '0');
            if (isMuted) window.speechSynthesis.cancel();
        });

        document.getElementById('contrast-toggle').addEventListener('click', () => {
            document.body.classList.toggle('high-contrast');
            localStorage.setItem('pref_contrast', document.body.classList.contains('high-contrast') ? '1' : '0');
        });

        document.getElementById('increase-font').addEventListener('click', () => {
            let currentSize = parseFloat(getComputedStyle(gameContainer).fontSize);
            const newSize = `${currentSize + 1}px`;
            gameContainer.style.fontSize = newSize;
            localStorage.setItem('pref_fontSize', newSize);
        });

        document.getElementById('decrease-font').addEventListener('click', () => {
            let currentSize = parseFloat(getComputedStyle(gameContainer).fontSize);
            const newSize = `${currentSize - 1}px`;
            gameContainer.style.fontSize = newSize;
            localStorage.setItem('pref_fontSize', newSize);
        });

        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'k') {
                keyboardMode = !keyboardMode;
                alert(`${i18n[currentLanguage].keyboard_mode_label}: ${keyboardMode ? 'ON' : 'OFF'}`);
                if (keyboardMode && !accessibilityMinigameContainer.classList.contains('hidden')) {
                    renderKeyboardDnD();
                }
            }
        });

        // Inicializa√ß√£o
        applyPreferences();
        initTTS();

    </script>
</body>

</html>